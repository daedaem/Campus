<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.project.dao.MateDao">

    <!-- mate 등록 -->
    <insert id="mateInsert" parameterType="com.ssafy.project.dto.MateDto" useGeneratedKeys="true" keyProperty="mateNo">
        INSERT INTO mate( mateCreateTime, mateUpdateTime, mateCampsite, mateCamptype, mateCampstart, mateCampend, lowestAge, highestAge,
                            mateTitle, mateContent, friendlimit, memberlimit, contentId, userNo )
                VALUES( now(), now(), #{mateCampsite},#{mateCamptype},#{mateCampstart},
                        #{mateCampend},#{lowestAge},#{highestAge},
                        #{mateTitle},#{mateContent},#{friendlimit},#{memberlimit}, #{contentId}, #{userNo} )
    </insert>

    <insert id="campStyleListInsert" parameterType="com.ssafy.project.dto.MateCampStyleDto" >
        INSERT INTO mateCampStyle ( mateNo, style1, style2, style3 ) 
                VALUES ( #{mateNo}, #{style1}, #{style2}, #{style3} )
    </insert>

    <insert id="campEquipReuireListInsert" parameterType="com.ssafy.project.dto.MateCampEquipRequiredDto" >
        INSERT INTO mateCampEquipRequire ( mateNo, brazier, burner, chair, icebox, lantern, powerstrip, sleepingbag, table1, tarp, tent)
                VALUES ( #{mateNo}, #{brazier}, #{burner}, #{chair}, #{icebox}, #{lantern}, #{powerstrip}, #{sleepingbag}, #{table1}, #{tarp}, #{tent})
    </insert>

    <select id="mateNoselect"  resultType="int">
        SELECT mateNo from mate where mateCampstyle is null
    </select>

    <update id="mateCheck" parameterType="int">
        UPDATE mate SET mateCampstyle = '1' WHERE mateNo = #{mateNo}
    </update>

    <update id="mateImageInsert" parameterType="com.ssafy.project.dto.MateDto" >
        UPDATE  mate SET mateImageUrl = #{mateImageUrl}
            WHERE mateNo = #{mateNo}
    </update>

    <!-- 모든 게시물 조회 -->
    <select id="mateList" parameterType="map" resultType="com.ssafy.project.dto.MateDto">
        select m.mateNo, m.mateCreateTime, m.mateUpdateTime, m.mateImageUrl, m.mateCampsite, m.mateCampstyle,
            m.mateCamptype, m.mateCampstart, m.mateCampend, m.contentId, m.mateStatus, m.userNo, m.lowestAge, m.mateContent,
            m.highestAge, m.mateTitle, m.memberlimit, u.userNickname
            from mate m, user u
            where m.userNo = u.userNo
            order by m.mateNo desc;
    </select>

    <!-- 게시물 삭제 -->
    <delete id="mateDelete" parameterType="int">
        DELETE FROM mateCampEquipRequire WHERE mateNo = #{mateNo};
        DELETE FROM mateCampStyle WHERE mateNo = #{mateNo};
        DELETE FROM mateList WHERE mateNo = #{mateNo};
        DELETE FROM mate WHERE mateNo = #{mateNo};
    </delete>
    
    <!-- 리스트 개수-->
    <select id="mateListTotalCount" resultType="int">
        select count(*) from mate
    </select>

    <!-- detail -->
    <select id="mateDetail" parameterType="int" resultType="com.ssafy.project.dto.MateDto">
        SELECT m.mateNo, m.mateCreateTime, m.mateUpdateTime, m.mateImageUrl, m.mateCampsite, m.mateCampstart, m.mateCampend, m.userNo, 
                m.lowestAge, m.highestAge, m.mateTitle, m.mateContent, m.friendlimit, m.memberlimit, u.userProfileImage, u.userNickName
        FROM mate m, user u
        WHERE m.userNo = u.userNo
            AND mateNo = #{mateNo}
    </select>

    <select id="mateCampStyleList" parameterType="int" resultType="com.ssafy.project.dto.MateCampStyleDto">
        SELECT style1, style2, style3
        FROM mateCampStyle
        WHERE mateNo = #{mateNo}
    </select>

    <select id="mateApplyList" parameterType="int" resultType="com.ssafy.project.dto.MateListDto">
        select u.userNo, r.userRatePoint, c.campStyle1,c.campStyle2, c.campStyle3, c.campStyle4, c.campStyle5, c.campStyle6, m.mateListNo, m.userNo, m.mateListNum, m.userAge, m.userGender, u.userMBTI
        from user u, userRate r, campStyle c, mateList m
        where u.userNo in (select userNo from mateList where mateNo = #{mateNo})
            and u.userNo = r.userNo
            and u.userNo = c.userNo
            and u.userNo = m.userNo
            and m.mateNo = #{mateNo};
    </select>

    <select id="userCampStyle" parameterType="int" resultType="com.ssafy.project.dto.MateListDto">
        SELECT u.userNo, r.userRatePoint, c.campStyle1,c.campStyle2, c.campStyle3, c.campStyle4, c.campStyle5, c.campStyle6 
        FROM user u, userRate r, campStyle c 
        WHERE u.userNo = #{userNo} and r.userNo = #{userNo} and c.userNo = #{userNo}
    </select>

    <select id="mateCampEquipRequiredList" parameterType="int" resultType="com.ssafy.project.dto.MateCampEquipRequiredDto">
        SELECT brazier, burner, chair, icebox, lantern,
                    powerstrip, sleepingbag, table1, tarp, tent
        FROM mateCampEquipRequire
        WHERE mateNo = #{mateNo}
    </select>

    <select id="mateSnsImageList" parameterType="int" resultType="com.ssafy.project.dto.SnsImageDto">
        SELECT snsImageNo, snsImageUrl, snsNo FROM snsImage
        WHERE snsNo IN (select snsNo FROM sns
                        WHERE userNo = #{userNo});
    </select>

    <!-- mate apply insert -->
    <insert id="mateApplyInsert" parameterType="com.ssafy.project.dto.MateCampStyleDto">
        INSERT INTO mateList (userNo, mateListNum, userAge, mateNo, userGender)
                VALUES (#{userNo}, #{mateListNum}, #{userAge}, #{mateNo}, #{userGender})
    </insert>

    <delete id="mateApplyDelete" parameterType="int">
       DELETE FROM mateList WHERE mateListNo = #{mateListNo};
    </delete>

    <!-- mate match -->
    <select id="userMBTIselect" parameterType="int" resultType="String">
        SELECT userMBTI FROM user WHERE userNo = #{userNo}
    </select>

    <select id="mateMatchList" parameterType="com.ssafy.project.dto.MateMatchDto" resultType="com.ssafy.project.dto.MateMatchDto">
    SELECT u.userNo, u.userNickname, u.userEmail, u.userGender, u.userMBTI, u.userProfileImage,c.campStyle1, c.campStyle2, c.campStyle3, c.campStyle4, c.campStyle5, c.campStyle6
        FROM user u, campStyle c 
        WHERE u.userNo IN (SELECT userNo FROM user WHERE userMBTI IN (SELECT mbti2 FROM mbti WHERE mbtiValue > 2 AND mbti1 = #{userMBTI})) 
        AND c.userNo = u.userNo AND u.userNo != #{userNo}
        ORDER BY rand()
        LIMIT 4;
    </select>


</mapper>